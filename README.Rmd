---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "Readme_files/"
)

devtools::load_all()
devtools::load_all("../ds.predict.base")
```

# ROC-GLM for DataSHIELD

## Overview

## Installation

#### Developer version:

The package is currently hosted at a private GitLab repository. If access is granted, the installation can be done via `devtools`:

```r
cred = git2r::cred_user_pass(username = "username", password = "password")
devtools::install_git("https://gitlab.lrz.de/difuture_analysegruppe/ds.roc.glm.git", credentials = cred)
```

Note that you have to supply your username and password from GitLab to install the package.

#### Register methods

It is necessary to register the assign and aggregate methods in the OPAL administration to use them.

__Assign methods:__

- `ds.roc.glm::rocGLMFrame`

__Aggregate methods:__

- `ds.roc.glm::getPositiveScores`
- `ds.roc.glm::getNegativeScores`
- `ds.roc.glm::calculateDistrGLMParts`

## Usage

The following code shows how to use the ROC-GLM.

```{r}
library(DSI)
library(DSOpal)
library(DSLite)
library(dsBaseClient)


## DataSHIELD login:
## ========================================

builder = DSI::newDSLoginBuilder()

builder$append(
  server   = "ibe",
  url      = "https://dsibe.ibe.med.uni-muenchen.de",
  user     = "ibe",
  password = "123456",
  table    = "ProVal.KUM"
)

logindata = builder$build()
connections = DSI::datashield.login(logins = logindata, assign = TRUE, symbol = "D", opts = list(ssl_verifyhost = 0, ssl_verifypeer=0))

### Get available tables:
DSI::datashield.symbols(connections)



## Read test data (same as on server)
## ========================================

# We use this data to calculate a model which we want to evaluate. Here a simple logistic regression:
dat = read.csv("data/test-kum.csv")
mod = glm(gender ~ age + height, family = "binomial", data = dat)



## Preperation for ROC-GLM
## ========================================

### The ROC-GLM requires scores and true values. The function `predictModel` calculates the
### scores based on a model. In our case the logistic regression form above.

### Upload model to DataSHIELD server:
pushModel(connections, mod)

### Predict uploaded model on server data. Scores are stored in an object called `pred`:
predictModel(connections, mod, "pred", "D", predict_fun = "predict(mod, newdata = D, type = 'response')")

### The `pred` object is later used for the ROC-GLM.

### Get object on server:
DSI::datashield.symbols(connections)



## Calculate and visualize ROC-GLM
## ========================================

### Now, calculate ROC-GLM:
roc_glm = dsROCGLM(connections, "D$gender", "pred")
roc_glm

### And plot it:
plot(roc_glm)



## Logout from DataSHIELD server
## ========================================

DSI::datashield.logout(conns = connections, save = FALSE)
```

